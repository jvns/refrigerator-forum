<p id="notice"><%= notice %></p>

<h1 class="text-4xl text-bold text-center"> <%= @topic.title %> </h1>
  <script>
  $( function() {
    $( ".draggable" ).draggable({ containment: "#post-box", scroll: false });
    $('#new_post').on('ajax:before', function(event, xhr, status, error) {
      let canvasRect = document.querySelector('#canvas').getBoundingClientRect()
      let words = [];
      for (x of $('.draggable')) {
          let rect = x.getBoundingClientRect();
          let word = {
            text: x.innerText,
            top: rect.top - canvasRect.top,
            left: rect.left - canvasRect.left
          }
          if (word.top > 0 && word.left > 0 && word.top < canvasRect.height && word.left < canvasRect.width) {
            words.push(word)
          }
      }
      document.querySelector('#poetry').value = JSON.stringify(words);
    });
  } );
  
  </script>
<div class="flex">
  <div class="m-auto max-w-screen-md w-full">
  <% @posts.each do |post| %>
      <div class="p-4">
        <% post.text.split("\n") do |line| %>
          <div class="pt-1">
          <% line.split do |word| %>

          <span class="poetry"> <%= word %> </span>
          <% end %>
          </div>
        <% end %>

      </div>
      <div class="flex bg-gray-200 p-2">
        <div class="text-left">by <%= link_to post.user.username, user_path(post.user) %> </div>
        <div class="px-4"><%= link_to 'delete', post, :method => :delete, :confirm => "Are you sure?" %></div>
        <div class="text-right flex-grow"> <%= post.created_at.to_s(:short) %> </div>
      </div>
  <% end %>


<div id="post-box" class="relative" style="height: 350px">
  <div id="canvas" style="width: 300px; height: 300px; position: absolute; left: 20px; top: 20px; border: 1px dashed black;">
  </div>
  <% @words.each do |word| %>
    <div class="draggable poetry cursor-pointer m-2" ><%= word %> </div>
  <% end %>
</div>

<%= form_with scope: :post, id: 'new_post', url: posts_path do |form| %>
  <p class="py-8">
    <input type="hidden" name="post[text]" id="poetry" />
    <%= hidden_field(:topic, :id) %>
    <%= form.submit "Save post" %>
  </p>
<% end %>

</div>
</div>

<%= link_to 'Edit', edit_topic_path(@topic) %> |
<%= link_to 'Back', topics_path %>
